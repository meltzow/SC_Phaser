var e=Object.defineProperty,t=(t,i,n)=>(((t,i,n)=>{i in t?e(t,i,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[i]=n})(t,"symbol"!=typeof i?i+"":i,n),n);import{P as i,B as n,d as s,T as a,a as r,b as o,e as l,c,f as d,g as u,h}from"./vendor.5ab9bc5f.js";!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver((e=>{for(const i of e)if("childList"===i.type)for(const e of i.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)})).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerpolicy&&(t.referrerPolicy=e.referrerpolicy),"use-credentials"===e.crossorigin?t.credentials="include":"anonymous"===e.crossorigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();var m={type:i.AUTO,parent:"game",backgroundColor:"#33A5E7",scale:{width:800,height:600,mode:i.Scale.FIT,autoCenter:i.Scale.CENTER_BOTH},plugins:{scene:[{key:"rexBoard",plugin:n,mapping:"rexBoard"}]}};const g=s({x:a.ui32,y:a.ui32}),p=s({x:a.f32,y:a.f32}),y=s({texture:a.ui8});var w,f;(f=w||(w={}))[f.TankBlue=0]="TankBlue",f[f.TankGreen=1]="TankGreen",f[f.TankRed=2]="TankRed",f[f.Link=3]="Link";const b=s({angle:a.f32,direction:a.ui8});var k,x;(x=k||(k={}))[x.None=0]="None",x[x.Left=1]="Left",x[x.Right=2]="Right",x[x.Up=3]="Up",x[x.Down=4]="Down";const T=s({resources:[a.ui8,3],ID:a.ui8,selectedUnits:[a.ui8,50],enemyPlayerIds:[a.ui8,50]}),I=s({timeBetweenActions:a.ui32,accumulatedTime:a.ui32});var v,C;(C=v||(v={}))[C.debug=0]="debug",C[C.play=1]="play",C[C.paused=2]="paused",C[C.gameOver=3]="gameOver",C[C.won=4]="won";const L=s({timeBetweenActions:a.ui32,accumulatedTime:a.ui32,status:a.ui8,levelName:a.ui8,debug:a.ui8,UNIT_TYPES:a.ui8,map:a.ui8}),E=s({value:a.ui8}),N=s({timeBetweenActions:a.ui32,accumulatedTime:a.ui32,commands:[a.ui8,5]}),S=s({type:a.ui8,targetX:a.f32,targetY:a.f32});var B,A,G,O,D,U;(A=B||(B={}))[A.NONE=0]="NONE",A[A.GOTO=1]="GOTO",A[A.ATTACK=2]="ATTACK",i.Tilemaps.Tilemap,(O=G||(G={}))[O.NONE=0]="NONE",O[O.DRAG=1]="DRAG",O[O.SINGLE_CLICK=2]="SINGLE_CLICK",O[O.DOUBLE_CLICK=3]="DOUBLE_CLICK",O[O.CLICK_BUILDING=4]="CLICK_BUILDING",O[O.PLACE_BUILDING=5]="PLACE_BUILDING",(U=D||(D={}))[U.singleClick=0]="singleClick",U[U.doubleClick=1]="doubleClick";const P=s({mouseX:a.ui8,mouseY:a.ui8,mouseStatus:a.ui8,CAMERA_SPEED:a.ui8,DOUBLE_CLICK_TIME:a.ui8,click:a.ui8}),R=s({LAYER_ANIMATION:a.ui32,tileheight:a.ui8,tilewidth:a.ui8,height:a.ui8,width:a.ui8}),M=s({timeBetweenActions:a.ui32,accumulatedTime:a.ui32});function _(e,t,n,s){const a={font:"32px Arial",fill:"#fff",boundsAlignH:"center",boundsAlignV:"middle"};let l,c;function d(e,t){switch(t){case 0:e.tint=11206570;break;case 1:e.tint=16755370;break;case 2:e.tint=11184895;break;case 3:e.tint=16755455;break;default:console.error("Undefined player id "+t)}}!function(){l=n.cameras.main,function(){for(let e=0;e<3;e++){const t=l.width-250+70*e,i=10;n.add.text(t+30,i,"2",a).setScrollFactor(0);const s=n.add.sprite(t,i,"crystal");s.setScrollFactor(0),s.setDisplaySize(32,32),d(s,e)}}();const e=n.input.keyboard.createCursorKeys(),t={camera:n.cameras.main,left:e.left,right:e.right,up:e.up,down:e.down,speed:.5,zoomIn:n.input.keyboard.addKey("A"),zoomOut:n.input.keyboard.addKey("Q")};c=new i.Cameras.Controls.FixedKeyControl(t)}(),function(){const e=r([R])(s)[0],t=n.cameras.add(l.width-100,l.height-100,90,90,!1,"minimap");t.zoom=.0625,t.setBounds(0,0,R.width[e]*R.tilewidth[e],R.height[e]*R.tileheight[e])}();const u=r([T,P,M]);return o((e=>{const t=u(e),i=n.game.loop.delta;c.update(i);for(let n=0;n<t.length;++n)t[n];return e}))}i.Cameras.Scene2D.Camera,i.Cameras.Controls.FixedKeyControl;const K=s({timeBetweenActions:a.ui32,accumulatedTime:a.ui32,ID:a.ui8,type:a.ui8,playerId:a.ui16,maxLife:a.ui16});var W,Y,j,X;(Y=W||(W={}))[Y.player=0]="player",Y[Y.enemies=1]="enemies",Y[Y.resources=2]="resources",Y[Y.allies=3]="allies",Y[Y.buildings=4]="buildings",(X=j||(j={}))[X.walking=0]="walking",X[X.idle=1]="idle";const z=s({timeBetweenActions:a.ui32,accumulatedTime:a.ui32});i.Tilemaps.Tilemap;const H=class{constructor(){t(this,"BUILDING_COST",10),t(this,"UNIT_COST",5),t(this,"PLAYER_ID",0)}static typeToName(e){return["rock","paper","scissor"][e]}static flatten(e){let t=[];for(let i=0;i<e.length;i++)t=t.concat(e[i]);return t}static enemyObjects(e,t){let i=[];const n=T.enemyPlayerIds[e];for(let s=0;s<Global.units.length;s++)-1!=n.indexOf(s)&&(i=i.concat(t[s]));return i}static allUnits(){return r([I,p,b,P])}static random(e,t){return Math.floor(Math.random()*(t-e+1)+e)}static randomArray(e){if(e.length>0){return e[this.random(0,e.length-1)]}}static spiral(e){let t=0,i=0,n=0,s=1;for(let a=0;a<e;a++)switch(n){case 0:t++,t==s&&n++;break;case 1:i++,i==s&&n++;break;case 2:t--,-t==s&&n++;break;case 3:i--,-i==s&&(n=0,s++)}return[t,i]}static distance(e,t){return Math.sqrt(Math.pow(e.x-t.x,2)+Math.pow(e.y-t.y,2))}static closest(e,t){let i,n;for(let s=0;s<t.length;s++){const a=t[s],r=this.distance(e,a.properties());(!i||r<n)&&(n=r,i=a)}return i}static myUnits(e,t){return r([g,z,K])(t)}static mySelectedUnits(e,t){return r([g,z,K])(t)}static allies(e){let t=[];const i=T.enemyPlayerIds[e];for(let n=0;n<Global.units.length;n++)if(-1==i.indexOf(n)&&n!=e){const e=Global.units[n];t=t.concat(e)}return t}static enemies(e){return H.enemyObjects(e,Global.units)}static tintSprite(e,t){switch(t){case 0:e.tint=11206570;break;case 1:e.tint=16755370;break;case 2:e.tint=11184895;break;case 3:e.tint=16755455;break;default:console.error("Undefined player id "+t)}}static onUnitInArea(e,t,i,n,s,a){void 0===a&&(a=!0);const r=Global.game.time.create(!0),o=new Phaser.Geom.Rectangle(e,t,i,n);r.loop(1e3,(function(){for(let e=0;e<Global.selectedUnits[milliseconds].length;e++){const t=T.selectedUnits[PLAYER_ID][e];if(o.contains(t.properties().x,t.properties().y))return console.log("Unit in area ",a),a&&r.destroy(),void s(t)}})),r.start()}static damage(e,t){let i=2;return 0===t&&1==e||1==t&&2==e||2==t&&0===e?i*=2:(1==t&&0===e||2==t&&1==e||0===t&&2==e)&&(i/=2),i}static textButton(e,t,i,n){const s=Global.game,a=200,r=s.add.button(e-100,t,"button",n);r.width=a,r.height=50;s.add.text(e,t,i,{font:"32px Arial",fill:"#ff0000",boundsAlignH:"center",boundsAlignV:"middle"}).setTextBounds(-100,10,a,50)}static progressBar(e,t,i){const n=new Phaser.Geom.Rectangle(e,t,0,10),s=new Phaser.Geom.Rectangle(e,t,32,10);H.progressRender.push({rect:n,background:s});Global.game.time.events.repeat(i/10,10,(function(){n.width+=3.2,s.x=n.right,s.width=32-n.width}))}static render(){const e=Global.game;H.progressRender.forEach((function(t){t.background.width>.1&&(e.debug.geom(t.rect,"rgba(117,213,255,0.5)"),e.debug.geom(t.background,"rgba(23, 74,151,0.5)"))}))}};let F=H;t(F,"progressRender",[]),t(F,"levelResources"),t(F,"UNIT_TYPES",3);const V=class extends Phaser.Events.EventEmitter{constructor(){super()}static getInstance(){return V.instance}};let q=V;t(q,"instance",new V);class J{constructor(){t(this,"ids")}}class Q{constructor(){t(this,"ids",[])}}var Z,$,ee,te;($=Z||(Z={}))[$.single=0]="single",$[$.double=1]="double";class ie{constructor(e,t,i,n=0){this.button=e,this.x=t,this.y=i,this.clickType=n}}function ne(e,t,n){let s,a,r,l,c,h;function m(e,t,i,n){r.x=e,r.y=t,r.width=i,r.height=n}function p(){const t=[];console.log("Select rectangle "+r.x+","+r.y+", "+r.width+","+r.height),F.myUnits(l,n).forEach((function(e){q.getInstance().emit(J.name,this,{ids:t}),i.Geom.Rectangle.Contains(r,g.x[e],g.y[e])&&t.push(e),q.getInstance().emit(Q.name,{ids:t})})),t.length>0&&(T.selectedUnits[void 0]=Uint8Array.from(t)),e.time.addEvent({delay:150,callback:function(){m(0,0,0,0)}}),console.log("selected units ",t)}function y(){return m(t.input.activePointer.worldX-.5,t.input.activePointer.worldY-.5,1,1),p()}function w(){e.input.activePointer.rightButtonDown()||h==G.NONE&&(s={x:t.input.activePointer.worldX,y:t.input.activePointer.worldY},h=e.time.now-a<300?G.DOUBLE_CLICK:G.SINGLE_CLICK,a=e.time.now)}function f(){if(h==G.PLACE_BUILDING||h==G.CLICK_BUILDING);else if(h!=G.NONE){Math.abs(s.x-t.input.mousePointer.x)+Math.abs(s.y-t.input.mousePointer.y)>20&&e.time.now-a>100&&(h=G.DRAG,m(Math.min(t.input.activePointer.worldX,s.x),Math.min(t.input.activePointer.worldY,s.y),Math.abs(t.input.activePointer.worldX-s.x),Math.abs(t.input.activePointer.worldY-s.y)))}}return h=G.NONE,c=e.add.graphics({lineStyle:{width:1,color:4278190131}}),e.input.keyboard.createCursorKeys(),e.input.on("pointerup",(function(){const i=t.input.activePointer.worldX,s=t.input.activePointer.worldY;if(e.time.now,e.input.activePointer.rightButtonReleased()){if(q.getInstance().emit(ie.name,new ie(ee.right,i,s)),!T.selectedUnits[void 0])return;T.selectedUnits[void 0].forEach((e=>{const t=d(n);u(n,S,t),S.type[t]=B.GOTO,S.targetX[t]=i,S.targetY[t]=s,N.commands[e][0]=t}))}else{switch(h){case G.SINGLE_CLICK:y(),q.getInstance().emit(ie.name,new ie(ee.left,i,s));break;case G.DOUBLE_CLICK:y()&&(m(-e.cameras.default.worldView.x,-e.cameras.default.worldView.y,e.cameras.default.width,e.cameras.default.height),m(0,0,0,0)),q.getInstance().emit(ie.name,new ie(ee.left,i,s,Z.double));break;case G.DRAG:p();break;default:console.error("no handled MouseStatus: "+h)}h!=G.PLACE_BUILDING&&(h=G.NONE)}})),e.input.on("pointerdown",w),e.input.on("pointermove",f),t.canvas.oncontextmenu=function(e){e.preventDefault()},r=new i.Geom.Rectangle(0,0,0,0),o((e=>(c.clear(),c.strokeRectShape(r),e)))}(te=ee||(ee={}))[te.left=0]="left",te[te.right=1]="right",te[te.middle=2]="middle",i.Tilemaps.Tilemap,i.Tilemaps.TilemapLayer;class se extends i.Scene{constructor(){super("game"),t(this,"cursors"),t(this,"world"),t(this,"playerSystem"),t(this,"cpuSystem"),t(this,"movementSystem"),t(this,"spriteSystem"),t(this,"hudSystem"),t(this,"levelSystem"),t(this,"controlSystem"),t(this,"debugSystem"),t(this,"map"),t(this,"groundLayer"),t(this,"rexBoard"),t(this,"board"),t(this,"print"),t(this,"cameraController"),t(this,"gameContainer"),t(this,"eventEmitter"),t(this,"spriteMap",new Map),this.gameContainer=document.getElementById("game-container"),this.eventEmitter=new i.Events.EventEmitter}init(){this.cursors=this.input.keyboard.createCursorKeys()}preload(){var e;(e=this).load.image("tank-blue","assets/tank_blue.png"),e.load.image("tank-green","assets/tank_green.png"),e.load.image("tank-red","assets/tank_red.png"),e.load.image("link","assets/animations/link/stand/001.png"),function(e){const t="assets/tilemaps/cross.json";console.log("Loading map ",t),e.load.tilemapTiledJSON("map",t),e.load.image("desert","assets/tilesets/desert.png"),e.load.image("objects","assets/tilesets/objects.png")}(this),function(e){e.load.image("crystal","assets/img/crystal-white.png"),e.load.image("fullscreen","assets/img/fullscreen.png")}(this),function(e){e.load.atlas("player","assets/img/link-white.png","assets/img/zelda32.json"),e.load.atlas("enemy","assets/img/enemy-white.png","assets/img/enemy.json"),e.load.atlas("enemy2","assets/img/enemy2.png","assets/img/enemy2.json"),e.load.scenePlugin({key:"rexboardplugin",url:"https://raw.githubusercontent.com/rexrainbow/phaser3-rex-notes/master/dist/rexboardplugin.min.js",sceneKey:"rexBoard"})}(this)}create(){const{width:e,height:t}=this.scale;this.world=h();const n=d(this.world);u(this.world,g,n),u(this.world,p,n),u(this.world,E,n),u(this.world,b,n),u(this.world,y,n),u(this.world,L,n),g.x[n]=200,g.y[n]=300,y.texture[n]=w.Link,u(this.world,T,n),T.ID[n]=0,u(this.world,K,n),u(this.world,z,n),u(this.world,N,n);for(let r=0;r<2;++r){const n=d(this.world);u(this.world,g,n),g.x[n]=i.Math.Between(.25*e,.75*e),g.y[n]=i.Math.Between(.25*t,.75*t),u(this.world,p,n),u(this.world,b,n),u(this.world,E,n),E.value[n]=10,u(this.world,y,n),y.texture[n]=i.Math.Between(w.TankBlue,w.TankRed),u(this.world,I,n),I.timeBetweenActions[n]=i.Math.Between(0,500),u(this.world,K,n)}const s={map:this.map,layer:this.groundLayer};this.levelSystem=function(e,t,i,n){return r([R]),function(){n.map=e.make.tilemap({key:"map"});const t=d(i);u(i,R,t),R.tileheight[t]=n.map.tileHeight,R.tilewidth[t]=n.map.tileWidth,R.width[t]=n.map.width,R.height[t]=n.map.height;const s=n.map.addTilesetImage("desert","desert"),a=n.map.addTilesetImage("objects","objects");n.layer=n.map.createLayer("ground",[s]),n.map.createLayer("objects",[a])}(),function(){console.log("Map ",n.map);for(let e=0;e<n.map.height;e++)for(let t=0;t<n.map.width;t++){const s=n.map.getTileAt(t,e,!0,"objects");let a;if(s)switch(s.index-1){case 0:case 6:case 12:a=d(i),u(i,K,a),u(i,g,a),u(i,b,a),g.x[a]=t*n.map.tileWidth,g.y[a]=e*n.map.tileHeight,K.ID[a]=a,K.playerId[a]=0,K.type[a]=W.player,u(i,y,a),y.texture[a]=w.Link,u(i,z,a),u(i,N,a)}}}(),o((e=>e))}(this,this.game,this.world,s),this.map=s.map,this.groundLayer=s.layer,this.playerSystem=function(e){const t=r([T,b]);return o((i=>{const n=t(i);for(let t=0;t<n.length;++t){const i=n[t];e&&(e.left.isDown?b.direction[i]=k.Left:e.right.isDown?b.direction[i]=k.Right:e.up.isDown?b.direction[i]=k.Up:e.down.isDown?b.direction[i]=k.Down:b.direction[i]=k.None)}return i}))}(this.cursors),this.cpuSystem=function(e){const t=r([I,p,b,g]);return o((n=>{const s=t(n),a=e.game.loop.delta;for(let e=0;e<s.length;++e){const t=s[e];if(I.accumulatedTime[t]+=a,!(I.accumulatedTime[t]<I.timeBetweenActions[t]))switch(I.accumulatedTime[t]=0,i.Math.Between(0,20)){case 0:b.direction[t]=k.Left;break;case 1:b.direction[t]=k.Right;break;case 2:b.direction[t]=k.Up;break;case 3:b.direction[t]=k.Down;break;default:b.direction[t]=k.None}}return n}))}(this),this.hudSystem=_(this.cursors,this.game,this,this.world);const a={board:this.board,spriteMap:this.spriteMap};this.movementSystem=function(e,t,i,n,s,a){const l=r([g,p,b,E,y,N]);return a.board=s.add.board({grid:{gridType:"quadGrid",x:0,y:0,cellWidth:i.tileWidth,cellHeight:i.tileHeight,type:"orthogonal"},width:i.width,height:i.height}),o((e=>{const t=l(e);for(let n=0;n<t.length;++n){const e=t[n],r=b.direction[e],o=E.value[e];switch(r){case k.None:p.x[e]=0,p.y[e]=0;break;case k.Left:p.x[e]=-o,p.y[e]=0,b.angle[e]=180;break;case k.Right:p.x[e]=o,p.y[e]=0,b.angle[e]=0;break;case k.Up:p.x[e]=0,p.y[e]=-o,b.angle[e]=270;break;case k.Down:p.x[e]=0,p.y[e]=o,b.angle[e]=90}const l=i.worldToTileX(g.x[e]+p.x[e]);l>0&&l<i.width&&(g.x[e]+=p.x[e]),g.y[e]+=p.y[e];const c=i.worldToTileY(g.y[e]+p.y[e]);c>0&&c<i.height&&(g.y[e]+=p.y[e]);const d=a.spriteMap.get(e);if(d){const t=N.commands[e][0];if(null!=t&&S.type[t]==B.GOTO){const i=a.board.worldXYToTileXY(S.targetX[t],S.targetY[t]);s.add.moveTo(d,{occupiedTest:!0}).moveCloser(i.x,i.y),g.x[e]=d.x,g.y[e]=d.y,S.targetX[t]==d.x&&S.targetY[t]==d.y&&(S.type[t]=B.NONE)}}}return e}))}(this.game,0,this.map,this.groundLayer,this.rexBoard,a),this.board=a.board,this.spriteMap=a.spriteMap,this.spriteSystem=function(e,t,i,n){const s=r([g,b,y]),a=l(s),d=c(s);return o((r=>{const o=a(r);for(let s=0;s<o.length;++s){const a=o[s],r=y.texture[a],l=t[r],c=e.add.sprite(g.x[a],g.y[a],l);i.set(a,c);const d=n.worldXYToTileXY(g.x[a],g.y[a]);n.addChess(c,d.x,d.y,0),c.rexChess.setBlocker()}const l=s(r);for(let e=0;e<l.length;++e){const t=l[e],n=i.get(t);n&&(n.x=g.x[t],n.y=g.y[t],n.angle=b.angle[t])}const c=d(r);for(let e=0;e<c.length;++e){const t=o[e];i.delete(t)}return r}))}(this,["tank-blue","tank-green","tank-red","link"],this.spriteMap,this.board),this.controlSystem=ne(this,this.game,this.world),this.debugSystem=function(e){function t(e){console.log(e)}const i=r([L]);return q.getInstance().on(Q.name,(e=>{t("Event ["+Q.name+"]: "+e)})),q.getInstance().on(ie.name,(e=>{t("Event ["+ie.name+"]: "+e)})),o((t=>{const n=i(t);e.game.loop.delta;for(let e=0;e<n.length;++e)n[e];return t}))}(this)}update(e,t){this.playerSystem(this.world),this.cpuSystem(this.world),this.hudSystem(this.world),this.movementSystem(this.world),this.spriteSystem(this.world),this.controlSystem(this.world)}resizeGameContainer(){const e=window.innerWidth/window.devicePixelRatio,t=window.innerHeight/window.devicePixelRatio,i=[{scrW:0,gamW:400},{scrW:600,gamW:450},{scrW:900,gamW:550},{scrW:1200,gamW:750},{scrW:1500,gamW:1e3},{scrW:1800,gamW:1300}];let n=null,s=0,a=0;for(let r=0;r<i.length&&(n=i[r],!(e<n.scrW));r++);s=n.gamW,a=n.gamW*(t/e),this.game.scale.resize(s,a),this.eventEmitter.emit("screenResized")}}const ae=new i.Game(Object.assign(m,{scene:[se]}));window.addEventListener("load",(()=>{window.addEventListener("resize",(e=>{for(let t=0;t<ae.scene.scenes.length;t++)ae.scene.scenes[t].resizeGameContainer()}))}));
