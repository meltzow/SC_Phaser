var e=Object.defineProperty,t=(t,i,n)=>(((t,i,n)=>{i in t?e(t,i,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[i]=n})(t,"symbol"!=typeof i?i+"":i,n),n);import{P as i,B as n,d as s,T as a,a as o,b as r,e as l,c,C as d,f as u,g as m,h}from"./vendor.47a5dd00.js";!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver((e=>{for(const i of e)if("childList"===i.type)for(const e of i.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)})).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerpolicy&&(t.referrerPolicy=e.referrerpolicy),"use-credentials"===e.crossorigin?t.credentials="include":"anonymous"===e.crossorigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();var g={type:i.AUTO,parent:"game",backgroundColor:"#33A5E7",scale:{width:800,height:600,mode:i.Scale.FIT,autoCenter:i.Scale.CENTER_BOTH},plugins:{scene:[{key:"rexBoard",plugin:n,mapping:"rexBoard"}]}};const p=s({x:a.ui32,y:a.ui32}),y=s({x:a.f32,y:a.f32}),w=s({texture:a.ui8});var f,b;(b=f||(f={}))[b.TankBlue=0]="TankBlue",b[b.TankGreen=1]="TankGreen",b[b.TankRed=2]="TankRed",b[b.Link=3]="Link";const x=s({angle:a.f32,direction:a.ui8});var k,C;(C=k||(k={}))[C.None=0]="None",C[C.Left=1]="Left",C[C.Right=2]="Right",C[C.Up=3]="Up",C[C.Down=4]="Down";const L=s({resources:[a.ui8,3],ID:a.ui8,selectedUnits:[a.ui8,50],enemyPlayerIds:[a.ui8,50]}),I=s({timeBetweenActions:a.ui32,accumulatedTime:a.ui32});var T,v;(v=T||(T={}))[v.debug=0]="debug",v[v.play=1]="play",v[v.paused=2]="paused",v[v.gameOver=3]="gameOver",v[v.won=4]="won";const E=s({timeBetweenActions:a.ui32,accumulatedTime:a.ui32,status:a.ui8,levelName:a.ui8,debug:a.ui8,UNIT_TYPES:a.ui8,map:a.ui8}),S=s({value:a.ui8}),N=s({timeBetweenActions:a.ui32,accumulatedTime:a.ui32,commands:[a.ui8,5]}),B=s({type:a.ui8,targetX:a.f32,targetY:a.f32});var A,D;(D=A||(A={}))[D.NONE=0]="NONE",D[D.GOTO=1]="GOTO",D[D.ATTACK=2]="ATTACK",i.Tilemaps.Tilemap;const O=s({LAYER_ANIMATION:a.ui32,tileheight:a.ui8,tilewidth:a.ui8,height:a.ui8,width:a.ui8}),P=s({timeBetweenActions:a.ui32,accumulatedTime:a.ui32,ID:a.ui8,type:a.ui8,playerId:a.ui16,maxLife:a.ui16,life:a.ui16});var G,M,U,_;(M=G||(G={}))[M.player=0]="player",M[M.enemies=1]="enemies",M[M.resources=2]="resources",M[M.allies=3]="allies",M[M.buildings=4]="buildings",(_=U||(U={}))[_.walking=0]="walking",_[_.idle=1]="idle";const K=s({timeBetweenActions:a.ui32,accumulatedTime:a.ui32,isSelected:a.ui8}),R=class extends Phaser.Events.EventEmitter{constructor(){super()}static getInstance(){return R.instance}};let W=R;t(W,"instance",new R);class Y{constructor(){t(this,"ids",[])}}function X(e,t,n,s,a,l){const c={font:"32px Arial",fill:"#fff",boundsAlignH:"center",boundsAlignV:"middle"};let u;const m=new Map;function h(e,t){switch(t){case 0:e.tint=11206570;break;case 1:e.tint=16755370;break;case 2:e.tint=11184895;break;case 3:e.tint=16755455;break;default:console.error("Undefined player id "+t)}}function g(e){const t=m.get(e),i=l.get(e);t&&i&&(t.x=i.getTopLeft().x,t.y=i.getTopLeft().y,t.width=i.width/(P.maxLife[e]/P.life[e]))}function y(e){m.forEach((e=>{e.destroy()}));o([L])(s),e&&(e.forEach((e=>{const t=l.get(e),i=n.add.rectangle(t.x,t.bottom,t.width,10);i.setStrokeStyle(1,4279343376),m.set(e,i)})),function(e){e&&e.forEach((e=>{g(e)}))}(e))}!function(){!function(){for(let e=0;e<3;e++){const t=a.width-250+70*e,i=10;n.add.text(t+30,i,"2",c).setScrollFactor(0);const s=n.add.sprite(t,i,"crystal");s.setScrollFactor(0),s.setDisplaySize(32,32),h(s,e)}}();const e=n.input.keyboard.createCursorKeys(),t={camera:n.cameras.main,left:e.left,right:e.right,up:e.up,down:e.down,speed:.5,zoomIn:n.input.keyboard.addKey("A"),zoomOut:n.input.keyboard.addKey("Q")};u=new i.Cameras.Controls.FixedKeyControl(t),W.getInstance().on(Y.name,(e=>{y(e.ids)}))}(),function(){const e=o([O])(s)[0],t=n.cameras.add(a.width-100,a.height-100,90,90,!1,"minimap");t.zoom=.0625,t.setBounds(0,0,O.width[e]*O.tilewidth[e],O.height[e]*O.tileheight[e])}();const w=o([K,d(p)]);return r((e=>{const t=w(e),i=n.game.loop.delta;u.update(i);const s=o([L])(e),a=Array.from(L.selectedUnits[s[0]]).filter((e=>e>0));for(let n=0;n<t.length;++n){const e=t[n];a.includes(e)&&g(e)}return e}))}var j,z,H,F,V,q,J,Q;i.Cameras.Scene2D.Camera,i.Cameras.Controls.FixedKeyControl,i.Tilemaps.Tilemap,(z=j||(j={}))[z.NONE=0]="NONE",z[z.DRAG=1]="DRAG",z[z.SINGLE_CLICK=2]="SINGLE_CLICK",z[z.DOUBLE_CLICK=3]="DOUBLE_CLICK",z[z.CLICK_BUILDING=4]="CLICK_BUILDING",z[z.PLACE_BUILDING=5]="PLACE_BUILDING",(F=H||(H={}))[F.singleClick=0]="singleClick",F[F.doubleClick=1]="doubleClick",s({mouseX:a.ui8,mouseY:a.ui8,mouseStatus:a.ui8,CAMERA_SPEED:a.ui8,DOUBLE_CLICK_TIME:a.ui8,click:a.ui8});class Z{constructor(){t(this,"ids",[])}}(q=V||(V={}))[q.single=0]="single",q[q.double=1]="double";class ${constructor(e,t,i,n=0){this.button=e,this.x=t,this.y=i,this.clickType=n}}function ee(e,t,n){let s,a,l,c,d,h;function g(e,t,i,n){l.x=e,l.y=t,l.width=i,l.height=n}function y(){const t=[];console.log("Select rectangle "+l.x+","+l.y+", "+l.width+","+l.height);const s=o([p,K,P])(n);W.getInstance().emit(Z.name,{ids:t}),s.forEach((function(e){i.Geom.Rectangle.Contains(l,p.x[e],p.y[e])&&t.push(e)})),W.getInstance().emit(Y.name,{ids:t}),t.length>0&&(L.selectedUnits[c]=Uint8Array.from(t)),e.time.addEvent({delay:150,callback:function(){g(0,0,0,0)}}),console.log("selected units ",t)}function w(){return g(t.input.activePointer.worldX-.5,t.input.activePointer.worldY-.5,1,1),y()}function f(){e.input.activePointer.rightButtonDown()||h==j.NONE&&(s={x:t.input.activePointer.worldX,y:t.input.activePointer.worldY},h=e.time.now-a<300?j.DOUBLE_CLICK:j.SINGLE_CLICK,a=e.time.now)}function b(){if(h==j.PLACE_BUILDING||h==j.CLICK_BUILDING);else if(h!=j.NONE){Math.abs(s.x-t.input.mousePointer.x)+Math.abs(s.y-t.input.mousePointer.y)>20&&e.time.now-a>100&&(h=j.DRAG,g(Math.min(t.input.activePointer.worldX,s.x),Math.min(t.input.activePointer.worldY,s.y),Math.abs(t.input.activePointer.worldX-s.x),Math.abs(t.input.activePointer.worldY-s.y)))}}return function(){h=j.NONE,d=e.add.graphics({lineStyle:{width:1,color:4279343376}}),e.input.keyboard.createCursorKeys();const s=o([L]);c=s(n)[0],e.input.on("pointerup",(function(){const i=t.input.activePointer.worldX,s=t.input.activePointer.worldY;if(e.time.now,e.input.activePointer.rightButtonReleased()){W.getInstance().emit($.name,new $(J.right,i,s));const e=L.selectedUnits[c];if(!e)return;e.forEach((e=>{const t=u(n);m(n,B,t),B.type[t]=A.GOTO,B.targetX[t]=i,B.targetY[t]=s,N.commands[e][0]=t}))}else{switch(h){case j.SINGLE_CLICK:w(),W.getInstance().emit($.name,new $(J.left,i,s));break;case j.DOUBLE_CLICK:w()&&(g(-e.cameras.default.worldView.x,-e.cameras.default.worldView.y,e.cameras.default.width,e.cameras.default.height),g(0,0,0,0)),W.getInstance().emit($.name,new $(J.left,i,s,V.double));break;case j.DRAG:y();break;default:console.error("no handled MouseStatus: "+h)}h!=j.PLACE_BUILDING&&(h=j.NONE)}})),e.input.on("pointerdown",f),e.input.on("pointermove",b),t.canvas.oncontextmenu=function(e){e.preventDefault()},l=new i.Geom.Rectangle(0,0,0,0)}(),r((e=>(d.clear(),d.strokeRectShape(l),e)))}(Q=J||(J={}))[Q.left=0]="left",Q[Q.right=1]="right",Q[Q.middle=2]="middle",i.Tilemaps.Tilemap,i.Tilemaps.TilemapLayer;class te extends i.Scene{constructor(){super("game"),t(this,"cursors"),t(this,"world"),t(this,"playerSystem"),t(this,"cpuSystem"),t(this,"movementSystem"),t(this,"spriteSystem"),t(this,"hudSystem"),t(this,"levelSystem"),t(this,"controlSystem"),t(this,"debugSystem"),t(this,"map"),t(this,"groundLayer"),t(this,"rexBoard"),t(this,"board"),t(this,"print"),t(this,"cameraController"),t(this,"gameContainer"),t(this,"eventEmitter"),t(this,"spriteMap",new Map),this.gameContainer=document.getElementById("game-container"),this.eventEmitter=new i.Events.EventEmitter}init(){this.cursors=this.input.keyboard.createCursorKeys()}preload(){var e;(e=this).load.image("tank-blue","assets/tank_blue.png"),e.load.image("tank-green","assets/tank_green.png"),e.load.image("tank-red","assets/tank_red.png"),e.load.image("link","assets/animations/link/stand/001.png"),function(e){const t="assets/tilemaps/cross.json";console.log("Loading map ",t),e.load.tilemapTiledJSON("map",t),e.load.image("desert","assets/tilesets/desert.png"),e.load.image("objects","assets/tilesets/objects.png")}(this),function(e){e.load.image("crystal","assets/img/crystal-white.png"),e.load.image("fullscreen","assets/img/fullscreen.png")}(this),function(e){e.load.atlas("player","assets/img/link-white.png","assets/img/zelda32.json"),e.load.atlas("enemy","assets/img/enemy-white.png","assets/img/enemy.json"),e.load.atlas("enemy2","assets/img/enemy2.png","assets/img/enemy2.json"),e.load.scenePlugin({key:"rexboardplugin",url:"https://raw.githubusercontent.com/rexrainbow/phaser3-rex-notes/master/dist/rexboardplugin.min.js",sceneKey:"rexBoard"})}(this)}create(){const{width:e,height:t}=this.scale;this.world=h();const n=u(this.world);m(this.world,E,n),m(this.world,L,n),L.ID[n]=0;for(let o=0;o<2;++o){const n=u(this.world);m(this.world,p,n),p.x[n]=i.Math.Between(.25*e,.75*e),p.y[n]=i.Math.Between(.25*t,.75*t),m(this.world,y,n),m(this.world,x,n),m(this.world,S,n),S.value[n]=10,m(this.world,w,n),w.texture[n]=i.Math.Between(f.TankBlue,f.TankRed),m(this.world,I,n),I.timeBetweenActions[n]=i.Math.Between(0,500),m(this.world,P,n)}const s={map:this.map,layer:this.groundLayer};this.levelSystem=function(e,t,i,n){return o([O]),function(){n.map=e.make.tilemap({key:"map"});const t=u(i);m(i,O,t),O.tileheight[t]=n.map.tileHeight,O.tilewidth[t]=n.map.tileWidth,O.width[t]=n.map.width,O.height[t]=n.map.height;const s=n.map.addTilesetImage("desert","desert");n.map.addTilesetImage("objects","objects"),n.layer=n.map.createLayer("ground",[s])}(),function(){console.log("Map ",n.map);for(let e=0;e<n.map.height;e++)for(let t=0;t<n.map.width;t++){const s=n.map.getTileAt(t,e,!1,"objects");let a;if(s)switch(s.index-1){case-1:break;case 1:case 7:case 13:a=u(i),m(i,P,a),m(i,p,a),m(i,y,a),m(i,S,a),m(i,x,a),p.x[a]=t*n.map.tileWidth,p.y[a]=e*n.map.tileHeight,P.ID[a]=a,P.playerId[a]=0,P.type[a]=G.player,P.maxLife[a]=10,P.life[a]=10,m(i,w,a),w.texture[a]=f.Link,m(i,K,a),m(i,N,a);break;default:console.warn("Found Unexpected "+s.index+" at "+t+"x"+e)}}}(),r((e=>e))}(this,this.game,this.world,s),this.map=s.map,this.groundLayer=s.layer,this.playerSystem=function(e){const t=o([L,x]);return r((i=>{const n=t(i);for(let t=0;t<n.length;++t){const i=n[t];e&&(e.left.isDown?x.direction[i]=k.Left:e.right.isDown?x.direction[i]=k.Right:e.up.isDown?x.direction[i]=k.Up:e.down.isDown?x.direction[i]=k.Down:x.direction[i]=k.None)}return i}))}(this.cursors),this.hudSystem=X(this.cursors,this.game,this,this.world,this.cameras.main,this.spriteMap);const a={board:this.board,spriteMap:this.spriteMap};this.movementSystem=function(e,t,i,n,s,a){const l=o([p,y,x,S,w,N]);return a.board=s.add.board({grid:{gridType:"quadGrid",x:0,y:0,cellWidth:i.tileWidth,cellHeight:i.tileHeight,type:"orthogonal"},width:i.width,height:i.height}),r((e=>{const t=l(e);for(let n=0;n<t.length;++n){const e=t[n],o=x.direction[e],r=S.value[e];switch(o){case k.None:y.x[e]=0,y.y[e]=0;break;case k.Left:y.x[e]=-r,y.y[e]=0,x.angle[e]=180;break;case k.Right:y.x[e]=r,y.y[e]=0,x.angle[e]=0;break;case k.Up:y.x[e]=0,y.y[e]=-r,x.angle[e]=270;break;case k.Down:y.x[e]=0,y.y[e]=r,x.angle[e]=90}const l=i.worldToTileX(p.x[e]+y.x[e]);l>0&&l<i.width&&(p.x[e]+=y.x[e]),p.y[e]+=y.y[e];const c=i.worldToTileY(p.y[e]+y.y[e]);c>0&&c<i.height&&(p.y[e]+=y.y[e]);const d=a.spriteMap.get(e);if(d){const t=N.commands[e][0];if(null!=t&&B.type[t]==A.GOTO){const i=a.board.worldXYToTileXY(B.targetX[t],B.targetY[t]);s.add.moveTo(d,{occupiedTest:!0}).moveCloser(i.x,i.y),p.x[e]=d.x,p.y[e]=d.y,B.targetX[t]==d.x&&B.targetY[t]==d.y&&(B.type[t]=A.NONE)}}}return e}))}(this.game,0,this.map,this.groundLayer,this.rexBoard,a),this.board=a.board,this.spriteMap=a.spriteMap,this.spriteSystem=function(e,t,i,n){const s=o([p,x,w]),a=l(s),d=c(s);return r((o=>{const r=a(o);for(let s=0;s<r.length;++s){const a=r[s],o=w.texture[a],l=t[o],c=e.add.sprite(p.x[a],p.y[a],l);i.set(a,c);const d=n.worldXYToTileXY(p.x[a],p.y[a]);n.addChess(c,d.x,d.y,0),c.rexChess.setBlocker()}const l=s(o);for(let e=0;e<l.length;++e){const t=l[e],n=i.get(t);n&&(n.x=p.x[t],n.y=p.y[t],n.angle=x.angle[t])}const c=d(o);for(let e=0;e<c.length;++e){const t=r[e];i.delete(t)}return o}))}(this,["tank-blue","tank-green","tank-red","link"],this.spriteMap,this.board),this.controlSystem=ee(this,this.game,this.world),this.debugSystem=function(e){function t(e){console.log(e)}const i=o([E]);return W.getInstance().on(Y.name,(e=>{t("Event ["+Y.name+"]: "+e)})),W.getInstance().on($.name,(e=>{t("Event ["+$.name+"]: "+e)})),r((t=>{const n=i(t);e.game.loop.delta;for(let e=0;e<n.length;++e)n[e];return t}))}(this)}update(e,t){this.playerSystem(this.world),this.hudSystem(this.world),this.movementSystem(this.world),this.spriteSystem(this.world),this.controlSystem(this.world)}resizeGameContainer(){const e=window.innerWidth/window.devicePixelRatio,t=window.innerHeight/window.devicePixelRatio,i=[{scrW:0,gamW:400},{scrW:600,gamW:450},{scrW:900,gamW:550},{scrW:1200,gamW:750},{scrW:1500,gamW:1e3},{scrW:1800,gamW:1300}];let n=null,s=0,a=0;for(let o=0;o<i.length&&(n=i[o],!(e<n.scrW));o++);s=n.gamW,a=n.gamW*(t/e),this.game.scale.resize(s,a),this.eventEmitter.emit("screenResized")}}const ie=new i.Game(Object.assign(g,{scene:[te]}));window.addEventListener("load",(()=>{window.addEventListener("resize",(e=>{for(let t=0;t<ie.scene.scenes.length;t++)ie.scene.scenes[t].resizeGameContainer()}))}));
