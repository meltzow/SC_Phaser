var ae=Object.defineProperty;var re=(e,n,t)=>n in e?ae(e,n,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[n]=t;var y=(e,n,t)=>(re(e,typeof n!="symbol"?n+"":n,t),t);import{P as v,B as le,d as N,T as a,a as O,b as W,e as ce,c as de,C as J,f as X,g as L,h as ue}from"./vendor.47a5dd00.js";const me=function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))o(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const d of r.addedNodes)d.tagName==="LINK"&&d.rel==="modulepreload"&&o(d)}).observe(document,{childList:!0,subtree:!0});function t(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerpolicy&&(r.referrerPolicy=i.referrerpolicy),i.crossorigin==="use-credentials"?r.credentials="include":i.crossorigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function o(i){if(i.ep)return;i.ep=!0;const r=t(i);fetch(i.href,r)}};me();var he={type:v.AUTO,parent:"game",backgroundColor:"#33A5E7",scale:{width:800,height:600,mode:v.Scale.FIT,autoCenter:v.Scale.CENTER_BOTH},plugins:{scene:[{key:"rexBoard",plugin:le,mapping:"rexBoard"}]}};const p=N({x:a.ui32,y:a.ui32}),x=N({x:a.f32,y:a.f32}),G=N({texture:a.ui8});var U;(function(e){e[e.TankBlue=0]="TankBlue",e[e.TankGreen=1]="TankGreen",e[e.TankRed=2]="TankRed",e[e.Link=3]="Link"})(U||(U={}));const C=N({angle:a.f32,direction:a.ui8});var P;(function(e){e[e.None=0]="None",e[e.Left=1]="Left",e[e.Right=2]="Right",e[e.Up=3]="Up",e[e.Down=4]="Down"})(P||(P={}));const H=N({resources:[a.ui8,3],ID:a.ui8,enemyPlayerIds:[a.ui8,50]}),Z=N({timeBetweenActions:a.ui32,accumulatedTime:a.ui32});var ee;(function(e){e[e.debug=0]="debug",e[e.play=1]="play",e[e.paused=2]="paused",e[e.gameOver=3]="gameOver",e[e.won=4]="won"})(ee||(ee={}));const te=N({timeBetweenActions:a.ui32,accumulatedTime:a.ui32,status:a.ui8,levelName:a.ui8,debug:a.ui8,UNIT_TYPES:a.ui8,map:a.ui8}),ge=3,Q=N({value:a.ui8}),F=N({timeBetweenActions:a.ui32,accumulatedTime:a.ui32,commands:[a.ui8,5]}),D=N({type:a.ui8,targetX:a.f32,targetY:a.f32});var j;(function(e){e[e.NONE=0]="NONE",e[e.GOTO=1]="GOTO",e[e.ATTACK=2]="ATTACK"})(j||(j={}));v.Tilemaps.Tilemap;function pe(e){e.load.atlas("player","assets/img/link-white.png","assets/img/zelda32.json"),e.load.atlas("enemy","assets/img/enemy-white.png","assets/img/enemy.json"),e.load.atlas("enemy2","assets/img/enemy2.png","assets/img/enemy2.json"),e.load.scenePlugin({key:"rexboardplugin",url:"https://raw.githubusercontent.com/rexrainbow/phaser3-rex-notes/master/dist/rexboardplugin.min.js",sceneKey:"rexBoard"})}function ye(e,n,t,o,i,r){const d=O([p,x,C,Q,G,F]);return(()=>{r.board=i.add.board({grid:{gridType:"quadGrid",x:0,y:0,cellWidth:t.tileWidth,cellHeight:t.tileHeight,type:"orthogonal"},width:t.width,height:t.height})})(),W(c=>{const k=d(c);for(let u=0;u<k.length;++u){const s=k[u],w=C.direction[s],I=Q.value[s];switch(w){case P.None:x.x[s]=0,x.y[s]=0;break;case P.Left:x.x[s]=-I,x.y[s]=0,C.angle[s]=180;break;case P.Right:x.x[s]=I,x.y[s]=0,C.angle[s]=0;break;case P.Up:x.x[s]=0,x.y[s]=-I,C.angle[s]=270;break;case P.Down:x.x[s]=0,x.y[s]=I,C.angle[s]=90;break}const _=t.worldToTileX(p.x[s]+x.x[s]);_>0&&_<t.width&&(p.x[s]+=x.x[s]),p.y[s]+=x.y[s];const h=t.worldToTileY(p.y[s]+x.y[s]);h>0&&h<t.height&&(p.y[s]+=x.y[s]);const g=r.spriteMap.get(s);if(g){const m=F.commands[s][0];if(m!=null&&D.type[m]==j.GOTO){const b=r.board.worldXYToTileXY(D.targetX[m],D.targetY[m]);i.add.moveTo(g,{occupiedTest:!0}).moveCloser(b.x,b.y),p.x[s]=g.x,p.y[s]=g.y,D.targetX[m]==g.x&&D.targetY[m]==g.y&&(D.type[m]=j.NONE)}}}return c})}function fe(e){e.load.image("tank-blue","assets/tank_blue.png"),e.load.image("tank-green","assets/tank_green.png"),e.load.image("tank-red","assets/tank_red.png"),e.load.image("link","assets/animations/link/stand/001.png")}function we(e,n,t,o){const i=O([p,C,G]),r=ce(i),d=de(i);return W(l=>{const c=r(l);for(let s=0;s<c.length;++s){const w=c[s],I=G.texture[w],_=n[I],h=e.add.sprite(p.x[w],p.y[w],_);t.set(w,h);const g=o.worldXYToTileXY(p.x[w],p.y[w]);o.addChess(h,g.x,g.y,0),h.rexChess.setBlocker()}const k=i(l);for(let s=0;s<k.length;++s){const w=k[s],I=t.get(w);!I||(I.x=p.x[w],I.y=p.y[w],I.angle=C.angle[w])}const u=d(l);for(let s=0;s<u.length;++s){const w=c[s];t.delete(w)}return l})}function be(e){const n=O([H,C]);return W(t=>{const o=n(t);for(let i=0;i<o.length;++i){const r=o[i];e&&(e.left.isDown?C.direction[r]=P.Left:e.right.isDown?C.direction[r]=P.Right:e.up.isDown?C.direction[r]=P.Up:e.down.isDown?C.direction[r]=P.Down:C.direction[r]=P.None)}return t})}const A=N({LAYER_ANIMATION:a.ui32,tileheight:a.ui8,tilewidth:a.ui8,height:a.ui8,width:a.ui8}),M=N({timeBetweenActions:a.ui32,accumulatedTime:a.ui32,ID:a.ui8,type:a.ui8,playerId:a.ui16,maxLife:a.ui16,life:a.ui16});var V;(function(e){e[e.player=0]="player",e[e.enemies=1]="enemies",e[e.resources=2]="resources",e[e.allies=3]="allies",e[e.buildings=4]="buildings"})(V||(V={}));var ie;(function(e){e[e.walking=0]="walking",e[e.idle=1]="idle"})(ie||(ie={}));const R=N({timeBetweenActions:a.ui32,accumulatedTime:a.ui32,isSelected:a.ui8});v.Cameras.Scene2D.Camera;v.Cameras.Controls.FixedKeyControl;function ve(e){e.load.image("crystal","assets/img/crystal-white.png"),e.load.image("fullscreen","assets/img/fullscreen.png")}function Le(e,n,t,o,i,r){const d={font:"32px Arial",fill:"#fff",boundsAlignH:"center",boundsAlignV:"middle"};let l;const c=new Map;function k(h,g){switch(g){case 0:h.tint=11206570;break;case 1:h.tint=16755370;break;case 2:h.tint=11184895;break;case 3:h.tint=16755455;break;default:console.error("Undefined player id "+g)}}function u(){for(let h=0;h<ge;h++){const g=i.width-250+h*70,m=10;t.add.text(g+30,m,"2",d).setScrollFactor(0);const b=t.add.sprite(g,m,"crystal");b.setScrollFactor(0),b.setDisplaySize(32,32),k(b,h)}}function s(){u();const h=t.input.keyboard.createCursorKeys(),g={camera:t.cameras.main,left:h.left,right:h.right,up:h.up,down:h.down,speed:.5,zoomIn:t.input.keyboard.addKey("A"),zoomOut:t.input.keyboard.addKey("Q")};l=new v.Cameras.Controls.FixedKeyControl(g)}function w(){const g=O([A])(o)[0],m=t.cameras.add(i.width-100,i.height-100,90,90,!1,"minimap");m.zoom=.125/2,m.setBounds(0,0,A.width[g]*A.tilewidth[g],A.height[g]*A.tileheight[g])}s(),w();const I=O([R,J(p)]),_=O([J(R)]);return W(h=>{const g=t.game.loop.delta;l.update(g);const m=_(h);for(let f=0;f<m.length;++f){const T=m[f];if(R.isSelected[T]){if(!c.has(T)){const B=r.get(T);if(B){const S=t.add.rectangle(B.getBottomLeft().x,B.getBottomLeft().y,B.width,10);S.setStrokeStyle(1,4279343376),c.set(T,S)}}}else c.delete(f)}const b=I(h);for(let f=0;f<b.length;++f){const T=b[f],B=c.get(T),S=r.get(T);B&&S&&(B.x=S.getBottomLeft().x,B.y=S.getBottomLeft().y,B.width=S.width/(M.maxLife[T]/M.life[T]))}return h})}v.Tilemaps.Tilemap;function xe(e){const n="assets/tilemaps/cross.json";console.log("Loading map ",n),e.load.tilemapTiledJSON("map",n),e.load.image("desert","assets/tilesets/desert.png"),e.load.image("objects","assets/tilesets/objects.png")}function ke(e,n,t,o){O([A]);const i=0;function r(){console.log("Map ",o.map);for(let l=0;l<o.map.height;l++)for(let c=0;c<o.map.width;c++){const k=o.map.getTileAt(c,l,!1,"objects");let u;if(k)switch(k.index-1){case-1:break;case 1:case 7:case 13:u=X(t),L(t,M,u),L(t,p,u),L(t,x,u),L(t,Q,u),L(t,C,u),p.x[u]=c*o.map.tileWidth,p.y[u]=l*o.map.tileHeight,M.ID[u]=u,M.playerId[u]=i,M.type[u]=V.player,M.maxLife[u]=10,M.life[u]=10,L(t,G,u),G.texture[u]=U.Link,L(t,R,u),L(t,F,u);break;default:console.warn("Found Unexpected "+k.index+" at "+c+"x"+l)}}}function d(){o.map=e.make.tilemap({key:"map"});const l=X(t);L(t,A,l),A.tileheight[l]=o.map.tileHeight,A.tilewidth[l]=o.map.tileWidth,A.width[l]=o.map.width,A.height[l]=o.map.height;const c=o.map.addTilesetImage("desert","desert");o.map.addTilesetImage("objects","objects"),o.layer=o.map.createLayer("ground",[c])}return d(),r(),W(l=>l)}var E;(function(e){e[e.NONE=0]="NONE",e[e.DRAG=1]="DRAG",e[e.SINGLE_CLICK=2]="SINGLE_CLICK",e[e.DOUBLE_CLICK=3]="DOUBLE_CLICK",e[e.CLICK_BUILDING=4]="CLICK_BUILDING",e[e.PLACE_BUILDING=5]="PLACE_BUILDING"})(E||(E={}));var ne;(function(e){e[e.singleClick=0]="singleClick",e[e.doubleClick=1]="doubleClick"})(ne||(ne={}));N({mouseX:a.ui8,mouseY:a.ui8,mouseStatus:a.ui8,CAMERA_SPEED:a.ui8,DOUBLE_CLICK_TIME:a.ui8,click:a.ui8});const q=class extends Phaser.Events.EventEmitter{constructor(){super()}static getInstance(){return q.instance}};let Y=q;y(Y,"instance",new q);var $;(function(e){e[e.single=0]="single",e[e.double=1]="double"})($||($={}));class K{constructor(n,t,o,i=0){this.button=n,this.x=t,this.y=o,this.clickType=i}}var z;(function(e){e[e.left=0]="left",e[e.right=1]="right",e[e.middle=2]="middle"})(z||(z={}));function Ce(e,n,t){const o=300;let i,r,d,l,c;function k(m,b,f,T){d.x=m,d.y=b,d.width=f,d.height=T}function u(){console.log("Select rectangle "+d.x+","+d.y+", "+d.width+","+d.height),O([p,R,M])(t).forEach(function(f){v.Geom.Rectangle.Contains(d,p.x[f],p.y[f])?R.isSelected[f]=1:R.isSelected[f]=0}),e.time.addEvent({delay:150,callback:function(){k(0,0,0,0)}})}function s(){const m=1;return k(n.input.activePointer.worldX-m/2,n.input.activePointer.worldY-m/2,m,m),u()}function w(){s()&&(k(-e.cameras.default.worldView.x,-e.cameras.default.worldView.y,e.cameras.default.width,e.cameras.default.height),k(0,0,0,0))}function I(){e.input.activePointer.rightButtonDown()||c==E.NONE&&(i={x:n.input.activePointer.worldX,y:n.input.activePointer.worldY},e.time.now-r<o?c=E.DOUBLE_CLICK:c=E.SINGLE_CLICK,r=e.time.now)}function _(){c==E.PLACE_BUILDING||c==E.CLICK_BUILDING||c!=E.NONE&&Math.abs(i.x-n.input.mousePointer.x)+Math.abs(i.y-n.input.mousePointer.y)>20&&e.time.now-r>100&&(c=E.DRAG,k(Math.min(n.input.activePointer.worldX,i.x),Math.min(n.input.activePointer.worldY,i.y),Math.abs(n.input.activePointer.worldX-i.x),Math.abs(n.input.activePointer.worldY-i.y)))}function h(){c=E.NONE,l=e.add.graphics({lineStyle:{width:1,color:4279343376}}),e.input.keyboard.createCursorKeys(),O([H])(t)[0],e.input.on("pointerup",function(){const b=n.input.activePointer.worldX,f=n.input.activePointer.worldY;if(e.time.now-r,e.input.activePointer.rightButtonReleased()){Y.getInstance().emit(K.name,new K(z.right,b,f)),O([R])(t).forEach(B=>{if(R.isSelected[B]==1){const S=X(t);L(t,D,S),D.type[S]=j.GOTO,D.targetX[S]=b,D.targetY[S]=f,F.commands[B][0]=S}});return}switch(c){case E.SINGLE_CLICK:s(),Y.getInstance().emit(K.name,new K(z.left,b,f));break;case E.DOUBLE_CLICK:w(),Y.getInstance().emit(K.name,new K(z.left,b,f,$.double));break;case E.DRAG:u();break;default:console.error("no handled MouseStatus: "+c)}c!=E.PLACE_BUILDING&&(c=E.NONE)}),e.input.on("pointerdown",I),e.input.on("pointermove",_),n.canvas.oncontextmenu=function(b){b.preventDefault()},d=new v.Geom.Rectangle(0,0,0,0)}function g(){l.clear(),l.strokeRectShape(d)}return h(),W(m=>(g(),m))}class oe{constructor(){y(this,"ids",[])}}function Ie(e){function n(o){console.log(o)}const t=O([te]);return Y.getInstance().on(oe.name,o=>{n("Event ["+oe.name+"]: "+o)}),Y.getInstance().on(K.name,o=>{n("Event ["+K.name+"]: "+o)}),W(o=>{const i=t(o);e.game.loop.delta;for(let r=0;r<i.length;++r)i[r];return o})}v.Tilemaps.Tilemap;v.Tilemaps.TilemapLayer;class Ee extends v.Scene{constructor(){super("game");y(this,"cursors");y(this,"world");y(this,"playerSystem");y(this,"cpuSystem");y(this,"movementSystem");y(this,"spriteSystem");y(this,"hudSystem");y(this,"levelSystem");y(this,"controlSystem");y(this,"debugSystem");y(this,"map");y(this,"groundLayer");y(this,"rexBoard");y(this,"board");y(this,"print");y(this,"cameraController");y(this,"gameContainer");y(this,"eventEmitter");y(this,"spriteMap",new Map);this.gameContainer=document.getElementById("game-container"),this.eventEmitter=new v.Events.EventEmitter}init(){this.cursors=this.input.keyboard.createCursorKeys()}preload(){fe(this),xe(this),ve(this),pe(this)}create(){const{width:n,height:t}=this.scale;this.world=ue();const o=X(this.world);L(this.world,te,o),L(this.world,H,o),H.ID[o]=0;for(let d=0;d<2;++d){const l=X(this.world);L(this.world,p,l),p.x[l]=v.Math.Between(n*.25,n*.75),p.y[l]=v.Math.Between(t*.25,t*.75),L(this.world,x,l),L(this.world,C,l),L(this.world,Q,l),Q.value[l]=10,L(this.world,G,l),G.texture[l]=v.Math.Between(U.TankBlue,U.TankRed),L(this.world,Z,l),Z.timeBetweenActions[l]=v.Math.Between(0,500),L(this.world,M,l)}const i={map:this.map,layer:this.groundLayer};this.levelSystem=ke(this,this.game,this.world,i),this.map=i.map,this.groundLayer=i.layer,this.playerSystem=be(this.cursors),this.hudSystem=Le(this.cursors,this.game,this,this.world,this.cameras.main,this.spriteMap);const r={board:this.board,spriteMap:this.spriteMap};this.movementSystem=ye(this.game,this,this.map,this.groundLayer,this.rexBoard,r),this.board=r.board,this.spriteMap=r.spriteMap,this.spriteSystem=we(this,["tank-blue","tank-green","tank-red","link"],this.spriteMap,this.board),this.controlSystem=Ce(this,this.game,this.world),this.debugSystem=Ie(this)}update(n,t){this.playerSystem(this.world),this.hudSystem(this.world),this.movementSystem(this.world),this.spriteSystem(this.world),this.controlSystem(this.world)}resizeGameContainer(){const n=window.innerWidth/window.devicePixelRatio,t=window.innerHeight/window.devicePixelRatio,o=[{scrW:0,gamW:400},{scrW:600,gamW:450},{scrW:900,gamW:550},{scrW:1200,gamW:750},{scrW:1500,gamW:1e3},{scrW:1800,gamW:1300}];let i=null,r=0,d=0;for(let l=0;l<o.length&&(i=o[l],!(n<i.scrW));l++);r=i.gamW,d=i.gamW*(t/n),this.game.scale.resize(r,d),this.eventEmitter.emit("screenResized")}}const se=new v.Game(Object.assign(he,{scene:[Ee]}));window.addEventListener("load",()=>{window.addEventListener("resize",e=>{for(let n=0;n<se.scene.scenes.length;n++)se.scene.scenes[n].resizeGameContainer()})});
